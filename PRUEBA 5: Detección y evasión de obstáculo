#include <Servo.h>

// Motor
const int ENA = 4; //Cambiar
const int IN1 = 7; //Cambiar
const int IN2 = 6; //Cambiar

// Servos
Servo direccionServo;
Servo escaneoServo;

// Sensor
const int trigPin = 9; //Cambiar
const int echoPin = 10; //Cambiar

const int distSegura = 20;

void setup() {
  Serial.begin(9600);
  
  pinMode(ENA, OUTPUT);
  pinMode(IN1, OUTPUT);
  pinMode(IN2, OUTPUT);

  direccionServo.attach(10);  //Cambiar
  escaneoServo.attach(11);  //Cambiar

  pinMode(trigPin, OUTPUT);
  pinMode(echoPin, INPUT);

  direccionServo.write(90);
  escaneoServo.write(90);
}

void loop() {
  if (hayObstaculo()) {
    Serial.println("Obst√°culo detectado. Evadiendo...");
    evitarObstaculo();
  } else {
    motorAdelante();
    delay(1000);
    detenerMotor();
    delay(500);
  }
}

bool hayObstaculo() {
  int distanciaMin = 999;
  for (int angulo = 60; angulo <= 120; angulo += 30) {
    escaneoServo.write(angulo);
    delay(200);
    int distancia = medirDistancia();
    if (distancia < distanciaMin) {
      distanciaMin = distancia;
    }
  }
  escaneoServo.write(90);
  return distanciaMin < distSegura;
}

int medirDistancia() {
  digitalWrite(trigPin, LOW);
  delayMicroseconds(2);
  digitalWrite(trigPin, HIGH);
  delayMicroseconds(10);
  digitalWrite(trigPin, LOW);

  long duracion = pulseIn(echoPin, HIGH);
  int distancia = duracion * 0.034 / 2;
  return distancia;
}

void evitarObstaculo() {
  direccionServo.write(135);  // Gira izquierda
  motorAdelante();
  delay(800);
  detenerMotor();
  direccionServo.write(90);   // Centro
  delay(300);
}

void motorAdelante() {
  digitalWrite(ENA, HIGH);
  digitalWrite(IN1, HIGH);
  digitalWrite(IN2, LOW);
}

void detenerMotor() {
  digitalWrite(ENA, LOW);
}
